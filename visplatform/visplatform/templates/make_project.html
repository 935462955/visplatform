<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>visplatform</title>
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="../node_modules/mocha/mocha.css" rel="stylesheet" />
    <link rel="stylesheet" href="../node_modules/codemirror/lib/codemirror.css" />
    <link rel="stylesheet" href="../node_modules/codemirror/theme/monokai.css" />
    <link href='../node_modules/bootstrap/dist/css/bootstrap.css' rel='stylesheet'/>
    <link
      rel="stylesheet"
      href="../node_modules/codemirror/addon/scroll/simplescrollbars.css"
    />
    <link
      rel="stylesheet"
      href="../node_modules/codemirror/addon/hint/show-hint.css"
    />
    <style>

      a.replay {
        display: none !important;
      }
      #box1 {
        background-color: #272822;
        width: 32%;
        min-height: 100px;
      }
      #resizer1 {
        background-color: #333642;
        width: 2%;
        min-height: 100px;
        cursor:ew-resize
        
      }
      #container {
        width: 100%;
        display: flex;
        
      }
      #box2 {
        background-color: #272822;
        width: 32%;
        min-height: 100px;
      }
      #resizer2 {
        background-color: #333642;
        width: 2%;
        min-height: 100px;
        cursor:ew-resize
      }
      #box3 {
        background-color: #272822;
        width: 32%;
        min-height: 100px;
      }
      .toolbar {
        display: flex;
        justify-content:space-between;
        width: 100%;
        height: 30px;
        background-color: #1a1a1a;
        border-bottom: solid 1px#5E5E5E;
        font-family: 'Lato', 'Lucida Grande', 'Lucida Sans Unicode', Tahoma, Sans-Serif;
        color:#aaaebc;
        padding-top: 5px;
        padding-left: 5px;
      }
      .toolbar *{
        vertical-align:middle
      }
      #iframe {
        width: 100%;
        min-height: 1024px;
      }
      #horizon-resizer{
        width:100%;
        height:20px;
        background-color:#333642;
        cursor:ns-resize
      }
      .CodeMirror{
        height:500px;
      }
      .setting-btn{
        margin-right:10px;
        border:none;
        background-color: transparent;
      }
    </style>
  </head>

  <body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <a class="navbar-brand" href="{{ url_for('show_category') }}">课程</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
    <div class="navbar-nav">
      <a class="nav-item nav-link" href="#">项目说明</a>
      <a class="nav-item nav-link active" href="#">工作空间<span class="sr-only">(current)</span></a>

    </div>
  </div>
  <form class="form-inline">
    <!-- Button trigger modal -->
  <button class="btn btn-outline-secondary"  type="button" style="border:none"  data-toggle="modal" data-target="#tips">
  <svg class="bi bi-info-circle" width="1.5em" height="1.5em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
  <path d="M8.93 6.588l-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588z"/>
  <circle cx="8" cy="4.5" r="1"/>
</svg>
</button>
    <button class="btn btn-outline-success" id="save_btn" type="button">保存 & 提交</button>
    <button class="btn btn-outline-secondary" id="run_test_btn" type="button">运行测试</button>
  </form>
</nav>

<!-- Modal -->
<div class="modal fade" id="tips" tabindex="-1" role="dialog" aria-labelledby="modelTitleId" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">知识小提示</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
      </div>
      <div class="modal-body">
      提示具体内容
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>
    <div id="container">
      <div id="box1">
        <div class="toolbar"><div>HTML</div></div>
        <textarea id="html-textarea" name="html-textarea"></textarea>
      </div>
      <div id="resizer1"></div>
      <div id="box2">
        <div class="toolbar"><div>CSS</div></div>
        <textarea id="css-textarea" name="css-textarea"></textarea>
      </div>
      <div id="resizer2"></div>
      <div id="box3">
        <div class="toolbar">
        <div style="float:left">JS</div>
        <button class="setting-btn" >
        <svg class="bi bi-gear" width="1em" height="1em" viewBox="0 0 16 16" fill="white" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M8.837 1.626c-.246-.835-1.428-.835-1.674 0l-.094.319A1.873 1.873 0 0 1 4.377 3.06l-.292-.16c-.764-.415-1.6.42-1.184 1.185l.159.292a1.873 1.873 0 0 1-1.115 2.692l-.319.094c-.835.246-.835 1.428 0 1.674l.319.094a1.873 1.873 0 0 1 1.115 2.693l-.16.291c-.415.764.42 1.6 1.185 1.184l.292-.159a1.873 1.873 0 0 1 2.692 1.116l.094.318c.246.835 1.428.835 1.674 0l.094-.319a1.873 1.873 0 0 1 2.693-1.115l.291.16c.764.415 1.6-.42 1.184-1.185l-.159-.291a1.873 1.873 0 0 1 1.116-2.693l.318-.094c.835-.246.835-1.428 0-1.674l-.319-.094a1.873 1.873 0 0 1-1.115-2.692l.16-.292c.415-.764-.42-1.6-1.185-1.184l-.291.159A1.873 1.873 0 0 1 8.93 1.945l-.094-.319zm-2.633-.283c.527-1.79 3.065-1.79 3.592 0l.094.319a.873.873 0 0 0 1.255.52l.292-.16c1.64-.892 3.434.901 2.54 2.541l-.159.292a.873.873 0 0 0 .52 1.255l.319.094c1.79.527 1.79 3.065 0 3.592l-.319.094a.873.873 0 0 0-.52 1.255l.16.292c.893 1.64-.902 3.434-2.541 2.54l-.292-.159a.873.873 0 0 0-1.255.52l-.094.319c-.527 1.79-3.065 1.79-3.592 0l-.094-.319a.873.873 0 0 0-1.255-.52l-.292.16c-1.64.893-3.433-.902-2.54-2.541l.159-.292a.873.873 0 0 0-.52-1.255l-.319-.094c-1.79-.527-1.79-3.065 0-3.592l.319-.094a.873.873 0 0 0 .52-1.255l-.16-.292c-.892-1.64.902-3.433 2.541-2.54l.292.159a.873.873 0 0 0 1.255-.52l.094-.319z"/>
  <path fill-rule="evenodd" d="M8 5.754a2.246 2.246 0 1 0 0 4.492 2.246 2.246 0 0 0 0-4.492zM4.754 8a3.246 3.246 0 1 1 6.492 0 3.246 3.246 0 0 1-6.492 0z"/>
</svg></button></div>
        <textarea id="js-textarea" name="js-textarea"></textarea>
      </div>
    </div>
    <div id="horizon-resizer">
        
    </div>
   
    <div>
      <iframe id="iframe"  frameborder=1></iframe>
    </div>
<!-- 事件遮罩层-->
    <div id="mask" style="position:fixed;top:0;left:0;height:100%;width:100%;display: none;"></div>
    
    <script src="../node_modules/jquery/dist/jquery.min.js"></script>
    <script src='../node_modules/bootstrap/dist/js/bootstrap.js'></script>
    <script src="../node_modules/codemirror/lib/codemirror.js"></script>
    <script src="../node_modules/codemirror/mode/javascript/javascript.js"></script>
    <script src="../node_modules/codemirror/mode/xml/xml.js"></script>
    <script src="../node_modules/codemirror/mode/css/css.js"></script>
    <script src="../node_modules/codemirror/mode/htmlmixed/htmlmixed.js"></script>
    <script src="../node_modules/codemirror/addon/hint/xml-hint.js"></script>
    <script src="../node_modules/codemirror/addon/scroll/simplescrollbars.js"></script>
    <script src="../node_modules/codemirror/addon/hint/show-hint.js"></script>
    <script src="../node_modules/codemirror/addon/hint/html-hint.js"></script>
    <script src="../node_modules/codemirror/addon/hint/css-hint.js"></script>
    <script src="../node_modules/codemirror/addon/hint/javascript-hint.js"></script>
    <script>
      var html_editor = CodeMirror.fromTextArea(
        document.querySelector("#html-textarea"),
        {
          mode: "text/html",
          htmlMode: true,
          styleActiveLine: true,
          matchBrackets: true,
          matchClosing: true,
          lineNumbers: true,
          theme: "monokai",
          value: "<html>",
          scrollbarStyle: "overlay",
          smartIndent: false,
          extraKeys: {
            Ctrl: "autocomplete",
          },
          lineWrapping:true,
        }
      );
      html_editor.on("change", function () {
        // html_editor.showHint()
      });
      var css_editor = CodeMirror.fromTextArea(
        document.querySelector("#css-textarea"),
        {
          mode: "css",
          htmlMode: true,
          matchBrackets: true,
          matchClosing: true,
          lineNumbers: true,
          theme: "monokai",
          value: "11",
          scrollbarStyle: "overlay",
          smartIndent: false,
          extraKeys: { Ctrl: "autocomplete" },
        }
      );
      document.querySelector('#js-textarea').value = "function myScript(){return 100;}\n"
      var js_editor = CodeMirror.fromTextArea(
        document.querySelector("#js-textarea"),
        {
          mode: "javascript",
          htmlMode: true,
          matchBrackets: true,
          matchClosing: true,
          lineNumbers: true,
          theme: "monokai",
          scrollbarStyle: "overlay",
          smartIndent: false,
          extraKeys: { Ctrl: "autocomplete" },
        }
      );
      $('#run_test_btn').on('click',function(){
         document.querySelector('#iframe').contentWindow.document.querySelector('#mocha').innerHTML = ""
         document.querySelector('#iframe').contentWindow.mocha.run()
         document.querySelector('#iframe').contentWindow.$('#test-result-modal').modal('toggle')
        //doc.querySelector('#')
      })
      // 保存代码并显示到iframe
      //保存功能还没实现
      $("#save_btn").on("click", function () {
        html_editor.save();
        css_editor.save();
        js_editor.save();
        let html = $("#html-textarea").val();
        html = html.replace(
          /<html>|<\/html>|<head>|<\/head>|<body>|<\/body>/g,
          ""
        );
        let css = $("#css-textarea").val();
        css = css.replace(/<style>|<\/style>/g, "");
        let js = $("#js-textarea").val();
        doc =
          "<html lang='en'>" +
          "<head>" +
          "<link href='../node_modules/mocha/mocha.css' rel='stylesheet'/>"+
          "<link href='../node_modules/bootstrap/dist/css/bootstrap.css' rel='stylesheet'/>"+
          "<link href='../css/project_iframe.css' rel='stylesheet'/>"+
          "<style id='user_css'>" +
          css +
          "</style>" +
          "<body>" +
          html +
          `<div class="modal fade bd-example-modal-xl" id="test-result-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
           <div class="modal-dialog modal-dialog modal-xl">
           <div class="modal-content">
           <div class="modal-header">
           <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
           <button type="button" class="close" data-dismiss="modal" aria-label="Close">
           <span aria-hidden="true">&times;</span>
           </button>
           </div>
           <div class="modal-body">
           <div id="mocha"></div>
           </div>
           <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
           <button type="button" class="btn btn-primary">Save changes</button>
           </div>
           </div>
           </div>
           </div>`+
          "<script id='user_js'>" +
          js +
          "<\/script>" +
          "<script src='../node_modules/jquery/dist/jquery.min.js'><\/script>"+
          "<script src='../js/popper.js'><\/script>"+
          "<script src='../node_modules/bootstrap/dist/js/bootstrap.js'><\/script>"+
          "<script src='../node_modules/mocha/mocha.js'><\/script>"+
          "<script src='../node_modules/chai/chai.js'><\/script>"+
          "<script type='text/javascript' src='https://cdn.bootcss.com/vConsole/3.2.0/vconsole.min.js'><\/script>"+
          "<script src='../js/project_iframe.js'><\/script>"+
          "<script src='../js/test-project-util.js'><\/script>"+
          "<script src='../js/test4project/{{ filename }}'><\/script>"+
          "</body>" +
          "</html>";
        $("#iframe").attr("srcdoc", doc);
      });
    </script>

    <script>
        /* 代码窗口伸缩功能 */
      var begin_x1;
      var begin_x2;
      var dragging1;
      var dragging2;
      var parent = $("#container");
      var resizer1 = document.querySelector("#resizer1");
      var resizer2 = document.querySelector("#resizer2");
      var box1 = $("#box1");
      var box2 = $("#box2");
      var box3 = $("#box3");
      var static_box3;
      var static_box1;
      $(document).on("mousedown", "#resizer1", function (e) {
        begin_x1 = parseInt(e.clientX);
        dragging1 = true;
        static_box3 = parseInt((box3.width() / parent.width()) * 100);
        if (e.preventDefault) {
          e.preventDefault();
        } else {
          e.returnValue = false;
        }
      });
      $(document).on("mousemove", "#container", function (e) {
        if (dragging1) {
          if (
            resizer1.offsetWidth + resizer1.offsetLeft >
            resizer2.offsetLeft
          ) {
            console.log(static_box3);
            box1.width(100 - 3.9 - static_box3 + "%");
            box2.width("0.1%");
            box3.width(static_box3 + "%");
            return false;
          }
          let new_x1 = parseInt(e.clientX) - parseInt(begin_x1);
          begin_x1 = parseInt(e.clientX);
          let new_box1_width_percent =
            ((box1.width() + new_x1) / parent.width()) * 100;
          let box3_width_percent = (box3.width() / parent.width()) * 100;
          new_box2_width_percent =
            100 - 4 - new_box1_width_percent - box3_width_percent;
          box1.width(new_box1_width_percent + "%");
          box2.width(new_box2_width_percent + "%");
        }
      });
      $(document).on("mousedown", "#resizer2", function (e) {
        begin_x2 = parseInt(e.clientX);
        dragging2 = true;
        static_box1 = parseInt((box1.width() / parent.width()) * 100);
        if (e.preventDefault) {
          e.preventDefault();
        } else {
          e.returnValue = false;
        }
      });
      $(document).on("mousemove", "#container", function (e) {
        if (dragging2) {
          if (
            resizer2.offsetLeft <
            resizer1.offsetLeft + resizer1.offsetWidth
          ) {
            box3.width(100 - 3.9 - static_box1 + "%");
            box2.width("0.1%");
            box1.width(static_box1 + "%");
            return false;
          }

          let new_x2 = parseInt(e.clientX) - begin_x2;
          begin_x2 = parseInt(e.clientX);

          let new_box3_width_percent =
            ((box3.width() - new_x2) / parent.width()) * 100;
          let box1_width_percent = (box1.width() / parent.width()) * 100;
          new_box2_width_percent =
            100 - 4 - new_box3_width_percent - box1_width_percent;
          box3.width(new_box3_width_percent + "%");
          box2.width(new_box2_width_percent + "%");
        }
      });
      $(document).mouseup(function (e) {
      
        dragging1 = false;
        dragging2 = false;
      });
      var begin_y
      var dragging3
      var horizon_resizer = document.querySelector('#horizon-resizer') 
      $(document).on('mousedown','#horizon-resizer',function(e){
        $('#mask').css('display','block')
        begin_y =  parseInt(e.clientY)
        dragging3 = true
         if (e.preventDefault) {
          e.preventDefault();
        } else {
          e.returnValue = false;
        }
      })
      $(document).on('mousemove','body',function(e){
        if(dragging3){
          if(horizon_resizer.offsetTop < 250)
          {
            return false
          }
          let new_y = parseInt(e.clientY) - begin_y
          begin_y =  parseInt(e.clientY)
          old_h = document.querySelectorAll('.CodeMirror')[1].offsetHeight
          document.querySelectorAll('.CodeMirror').forEach(d=>d.style.height = old_h + new_y +'px' )
        }
      })
     
    // document.querySelector('#iframe').contentWindow.document.body.addEventListener('mousemove',function(){
    //    $('body').mousemove()
    //  })
    //  document.querySelector('#iframe').contentWindow.document.body.addEventListener('mouseup',function(){
    //    $('body').mouseup()
    //  })
      $(document).on('mouseup','body',function(e){
        dragging3 = false
        $('#mask').css('display','none')
        if(horizon_resizer.offsetTop < 250){
          document.querySelectorAll('.CodeMirror').forEach(d=>d.style.height = '250px' )
        }
      })
    </script>

  </body>
</html>
